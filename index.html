<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœè£…åº—é”€å”®ç®¡ç†ç³»ç»Ÿ</title>
    <!-- æ·»åŠ  Supabase CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // é¡µé¢åŠ è½½å‰ç«‹å³æ£€æµ‹URLå‚æ•°ï¼ˆæœ€å…³é”®ï¼ï¼‰
        (function(){
            var urlParams = new URLSearchParams(window.location.search);
            var mode = urlParams.get('mode');
            console.log('URLå‚æ•°æ£€æµ‹:', window.location.search, 'mode=', mode);
            
            if (mode === 'staff') {
                window.staffAutoLogin = true;
            } else if (mode === 'boss') {
                window.bossAutoLogin = true;
            }
        })();
    </script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','PingFang SC','Microsoft YaHei',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
        .container{max-width:900px;margin:0 auto}
        h1{text-align:center;color:white;margin-bottom:20px;font-size:28px;text-shadow:0 2px 4px rgba(0,0,0,0.2)}
        .card{background:white;border-radius:16px;padding:20px;margin-bottom:20px;box-shadow:0 10px 30px rgba(0,0,0,0.2)}
        .login-container{max-width:400px;margin:80px auto;text-align:center}
        .role-selector{display:grid;grid-template-columns:1fr;gap:20px;margin-top:30px}
        .role-card{background:white;padding:30px;border-radius:16px;cursor:pointer;transition:all 0.3s;border:3px solid transparent}
        .role-card.staff{border-color:#4caf50}
        .role-card.staff:hover{transform:translateY(-5px);box-shadow:0 10px 30px rgba(76,175,80,0.3)}
        .role-card.boss{border-color:#ff9800}
        .role-card.boss:hover{transform:translateY(-5px);box-shadow:0 10px 30px rgba(255,152,0,0.3)}
        .role-icon{font-size:48px;margin-bottom:10px}
        .role-title{font-size:20px;font-weight:bold;margin-bottom:5px}
        .role-desc{color:#666;font-size:14px;line-height:1.6}
        .no-password-badge{display:inline-block;background:#4caf50;color:white;padding:4px 12px;border-radius:12px;font-size:12px;margin-top:10px}
        .password-section{margin-top:20px}
        .password-input{width:100%;padding:15px;border:2px solid #ddd;border-radius:8px;font-size:18px;text-align:center;letter-spacing:8px;margin-bottom:15px}
        .password-input:focus{
            outline:none;
            border-color:#667eea;
            box-shadow:0 0 0 3px rgba(102,126,234,0.2);
        }
        .btn{width:100%;padding:15px;border:none;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;transition:all 0.3s}
        .btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white}
        .btn-secondary{background:#f0f0f0;color:#333;margin-top:10px}
        .back-link{display:inline-block;margin-top:15px;color:#666;text-decoration:none;font-size:14px}
        .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px}
        .mode-indicator{display:flex;align-items:center;gap:10px;color:white}
        .mode-badge{padding:6px 16px;border-radius:20px;font-size:14px;font-weight:bold}
        .mode-badge.staff{background:#4caf50}
        .mode-badge.boss{background:#ff9800}
        .logout-btn{background:rgba(255,255,255,0.2);color:white;border:1px solid rgba(255,255,255,0.3);padding:8px 16px;border-radius:8px;cursor:pointer;font-size:14px}
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-bottom:20px}
        .stat-box{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:20px;border-radius:12px;text-align:center}
        .stat-box.hidden{background:#e0e0e0;position:relative;overflow:hidden}
        .stat-box.hidden::after{content:"ğŸ”’";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:24px;opacity:0.5}
        .stat-box.hidden .stat-value{filter:blur(4px);user-select:none}
        .stat-label{font-size:13px;opacity:0.9;margin-bottom:5px}
        .stat-value{font-size:22px;font-weight:bold}
        .form-group{margin-bottom:15px}
        label{display:block;margin-bottom:5px;color:#333;font-weight:500}
        input,select{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:16px}
        input:focus,select:focus{outline:none;border-color:#667eea}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:15px}
        button[type="submit"]{width:100%;padding:15px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer}

        /* è¡¨å¤´ä¿æŒæ¨ªæ’ */
        .records-header{
            display:grid;
            grid-template-columns:2fr 1fr 1fr 1fr 1fr 1fr 100px;
            gap:10px;
            padding:12px 15px;
            background:#f8f9fa;
            border-radius:8px;
            margin-bottom:10px;
            font-weight:600;
            color:#666;
            font-size:13px;
            text-align:center;
        }
        .records-header.staff-view{
            grid-template-columns:2fr 1fr 1fr 1fr 80px;
        }
        .records-header span:first-child{text-align:left}

        /* é‡ç‚¹ï¼šè®°å½•è¡Œå¼ºåˆ¶æ¨ªæ’ï¼Œä¸å †å  */
        .record-row{
            display:grid !important;
            grid-template-columns:2fr 1fr 1fr 1fr 1fr 1fr 100px !important;
            gap:10px !important;
            padding:15px !important;
            border-bottom:1px solid #f0f0f0 !important;
            align-items:center !important;
            font-size:14px !important;
            background:white !important;
            border:none !important;
            margin-bottom:0 !important;
        }
        .record-row.staff-view{
            grid-template-columns:2fr 1fr 1fr 1fr 80px !important;
        }
        .record-row:hover{background:#fafafa !important;border-radius:8px !important}

        .record-product{
            display:flex !important;
            flex-direction:column !important;
            gap:4px !important;
        }
        .record-name{font-weight:600;color:#333;font-size:15px}
        .record-category{display:inline-block;padding:2px 8px;background:#e3f2fd;color:#1976d2;border-radius:4px;font-size:11px;width:fit-content}
        .record-date{color:#999;font-size:12px}
        .record-cell{text-align:center;color:#555}
        .record-price{font-weight:500;color:#333}
        .record-profit{font-weight:bold;font-size:15px}
        .profit-positive{color:#4caf50}
        .profit-negative{color:#f44336}
        .record-actions{text-align:center;display:flex;gap:5px;justify-content:center}
        .action-btn{padding:6px 10px;border:none;border-radius:6px;cursor:pointer;font-size:12px}
        .edit-btn{background:#e3f2fd;color:#1976d2}
        .delete-btn{background:#ffebee;color:#c62828}
        .empty-state{text-align:center;padding:60px 20px;color:#999}
        .empty-state-icon{font-size:48px;margin-bottom:10px}
        .date-filter{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}
        .date-filter button{flex:1;min-width:80px;padding:8px;font-size:14px;background:#f0f0f0;color:#333;border:none;border-radius:8px;cursor:pointer}
        .date-filter button.active{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white}
        .export-btn{background:#52c41a;margin-top:10px;width:100%;padding:12px;border:none;border-radius:8px;color:white;font-size:16px;cursor:pointer}
        .clear-btn{background:#ff4d4f;margin-top:10px;width:100%;padding:12px;border:none;border-radius:8px;color:white;font-size:16px;cursor:pointer}

        /* åˆè®¡è¡Œä¹Ÿä¿æŒæ¨ªæ’ */
        .summary-row{
            display:grid !important;
            grid-template-columns:2fr 1fr 1fr 1fr 1fr 1fr 100px !important;
            gap:10px !important;
            padding:15px !important;
            background:#f5f5f5 !important;
            border-radius:8px !important;
            margin-top:10px !important;
            font-weight:bold !important;
            color:#333 !important;
            border-top:2px solid #e0e0e0 !important;
        }
        .summary-row.staff-view{
            grid-template-columns:2fr 1fr 1fr 1fr 80px !important;
        }
        .summary-label{text-align:left;color:#666}

        .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;z-index:1000;padding:20px}
        .modal-overlay.active{display:flex}
        .modal-content{background:white;padding:25px;border-radius:16px;width:100%;max-width:400px}
        .modal-title{font-size:20px;font-weight:bold;margin-bottom:20px;color:#333}
        .modal-buttons{display:flex;gap:10px;margin-top:20px}
        .modal-buttons button{flex:1;padding:12px;border:none;border-radius:8px;font-size:16px;cursor:pointer}
        .btn-save{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white}
        .btn-cancel{background:#f0f0f0;color:#333}
        .current-value{background:#f5f5f5;padding:12px;border-radius:8px;margin-bottom:15px;font-size:14px;color:#666}
        .info-banner{background:#e3f2fd;border-left:4px solid #2196f3;padding:12px;margin-bottom:20px;border-radius:4px;color:#1976d2;font-size:14px}

        /* å–æ¶ˆç§»åŠ¨ç«¯å †å ï¼Œä¿æŒæ¨ªæ’ */
        @media(max-width:768px){
            .form-row{grid-template-columns:1fr}
            .stats-grid{grid-template-columns:1fr 1fr}
            .login-container{margin:40px auto}
        }
    </style>
</head>
<body>
    <div id="login-select" class="container">
        <div class="login-container">
            <h1 style="margin-bottom:10px">ğŸ‘— é”€å”®ç®¡ç†ç³»ç»Ÿ</h1>
            <p style="color:rgba(255,255,255,0.8);margin-bottom:30px">è¯·é€‰æ‹©èº«ä»½è¿›å…¥</p>
            <div class="role-selector">
                <div class="role-card staff" onclick="enterStaff()">
                    <div class="role-icon">ğŸ‘¤</div>
                    <div class="role-title">åº—å‘˜å…¥å£</div>
                    <div class="role-desc">å¿«é€Ÿå½•å…¥é”€å”®è®°å½•<br>æŸ¥çœ‹å½“æ—¥è¥æ”¶ç»Ÿè®¡</div>
                    <span class="no-password-badge">âœ“ å…å¯†ç ç›´æ¥è¿›å…¥</span>
                </div>
                <div class="role-card boss" onclick="showBossLogin()">
                    <div class="role-icon">ğŸ‘‘</div>
                    <div class="role-title">è€æ¿å…¥å£</div>
                    <div class="role-desc">æŸ¥çœ‹æˆæœ¬åˆ©æ¶¦æ•°æ®<br>ä¿®æ”¹æˆæœ¬ã€å¯¼å‡ºæŠ¥è¡¨</div>
                </div>
            </div>
        </div>
    </div>

    <div id="login-boss" class="container" style="display:none">
        <div class="login-container">
            <h1 style="margin-bottom:10px">ğŸ‘‘ è€æ¿éªŒè¯</h1>
            <p style="color:rgba(255,255,255,0.8);margin-bottom:30px">è¯·è¾“å…¥ç®¡ç†å¯†ç ï¼ˆé»˜è®¤ï¼šboss6666ï¼‰</p>
            <div class="password-section">
                <input type="password" id="boss-password" class="password-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" maxlength="8">
                <button class="btn btn-primary" onclick="enterBoss()">è¿›å…¥ç³»ç»Ÿ</button>
                <a href="#" class="back-link" onclick="backToSelect()">â† è¿”å›é€‰æ‹©</a>
            </div>
        </div>
    </div>

    <div id="app-page" style="display:none">
        <div class="container">
            <div class="header">
                <h1>ğŸ‘— é”€å”®ç®¡ç†ç³»ç»Ÿ</h1>
                <div class="mode-indicator">
                    <span id="mode-badge" class="mode-badge"></span>
                    <button class="logout-btn" onclick="logout()">é€€å‡º</button>
                </div>
            </div>
            <div id="info-banner" class="info-banner"></div>
            <div class="card">
                <div class="date-filter">
                    <button onclick="filterDate('today')" class="active" id="btn-today">ä»Šæ—¥</button>
                    <button onclick="filterDate('week')" id="btn-week">æœ¬å‘¨</button>
                    <button onclick="filterDate('month')" id="btn-month">æœ¬æœˆ</button>
                    <button onclick="filterDate('all')" id="btn-all">å…¨éƒ¨</button>
                </div>
                <div class="stats-grid" id="stats-grid"></div>
            </div>
            <div class="card" id="input-card">
                <h2 style="margin-bottom:15px;color:#333">ğŸ“ è®°ä¸€ç¬”</h2>
                <form id="sale-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>å•†å“åç§° *</label>
                            <input type="text" id="product-name" placeholder="ä¾‹å¦‚ï¼šç¢èŠ±è¿è¡£è£™" required>
                        </div>
                        <div class="form-group">
                            <label>åˆ†ç±»</label>
                            <select id="category">
                                <option value="ä¸Šè¡£">ä¸Šè¡£</option>
                                <option value="è£¤å­">è£¤å­</option>
                                <option value="è£™å­">è£™å­</option>
                                <option value="å¤–å¥—">å¤–å¥—</option>
                                <option value="é…é¥°">é…é¥°</option>
                                <option value="å…¶ä»–">å…¶ä»–</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>å”®ä»·ï¼ˆå…ƒï¼‰*</label>
                            <input type="number" id="sale-price" placeholder="199" min="0" step="0.01" required>
                        </div>
                        <div class="form-group" id="cost-group">
                            <label>æˆæœ¬ï¼ˆå…ƒï¼‰<span id="cost-hint" style="color:#999;font-size:12px"></span></label>
                            <input type="number" id="cost-price" placeholder="0" min="0" step="0.01">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>æ•°é‡ *</label>
                            <input type="number" id="quantity" placeholder="1" min="1" value="1" required>
                        </div>
                        <div class="form-group">
                            <label>æ—¥æœŸ</label>
                            <input type="date" id="sale-date" required>
                        </div>
                    </div>
                    <button type="submit" id="submit-btn">â• æ·»åŠ è®°å½•</button>
                </form>
            </div>
            <div class="card">
                <h2 style="margin-bottom:15px;color:#333">ğŸ“‹ é”€å”®è®°å½•</h2>
                <div class="records-header" id="records-header"></div>
                <div id="records-list">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“­</div>
                        <div>æš‚æ— è®°å½•</div>
                    </div>
                </div>
                <button class="export-btn" onclick="exportData()" id="export-btn">ğŸ“¥ å¯¼å‡ºExcel</button>
                <button class="clear-btn" onclick="clearAll()" id="clear-btn">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="edit-modal">
        <div class="modal-content">
            <div class="modal-title">âœï¸ ä¿®æ”¹æˆæœ¬</div>
            <div class="current-value" id="current-info"></div>
            <div class="form-group">
                <label>æ–°æˆæœ¬ï¼ˆå…ƒï¼‰</label>
                <input type="number" id="edit-cost" min="0" step="0.01" placeholder="è¾“å…¥æ–°æˆæœ¬">
            </div>
            <div class="modal-buttons">
                <button class="btn-save" onclick="saveEdit()">ä¿å­˜</button>
                <button class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // é…ç½®ï¼šä¿®æ”¹è€æ¿å¯†ç ä¸º boss6666ï¼ˆä½ å¯ä»¥æ”¹æˆä»»æ„å¯†ç ï¼‰
        const CONFIG={bossPassword:'boss6666',defaultCost:0};
        let currentRole='staff',records=[],currentFilter='today',editingId=null;

        // Supabase é…ç½® - å¿…é¡»æ›¿æ¢æˆä½ çš„å®é™…å¯†é’¥ï¼
        const SUPABASE_URL = 'https://kmgwhidixermpgxuaglv.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImttZ3doaWRpeGVybXBneHVhZ2x2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3NjQ1OTYsImV4cCI6MjA4NzM0MDU5Nn0.0GlxvIrd_9ABlY96ML5TbyFrKBYIOtzCZnVAQR-k9NY'
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

        // åŠ è½½æ•°æ®
        async function loadData() {
            const { data, error } = await supabaseClient
                .from('sales')
                .select('*')
                .order('timestamp', { ascending: false })
            
            if (error) {
                console.error('åŠ è½½å¤±è´¥:', error)
                alert('æ•°æ®åŠ è½½å¤±è´¥: ' + error.message)
                records = []
            } else {
                records = data || []
            }
            updateStats()
            updateTable()
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œï¼ˆä¿®å¤URLè·³è½¬é€»è¾‘ï¼‰
        document.addEventListener('DOMContentLoaded',function(){
            var urlParams=new URLSearchParams(window.location.search);
            var mode=urlParams.get('mode');
            console.log('URLå‚æ•°:',window.location.search,'mode=',mode);
            
            if(mode==='staff'){
                currentRole='staff';
                document.getElementById('login-select').style.display='none';
                document.getElementById('app-page').style.display='block';
                initApp();
            }else if(mode==='boss'){
                document.getElementById('login-select').style.display='none';
                document.getElementById('login-boss').style.display='block';
                setTimeout(function(){document.getElementById('boss-password').focus()},100);
            }
        });

        function enterStaff(){currentRole='staff';showApp()}
        function showBossLogin(){document.getElementById('login-select').style.display='none';document.getElementById('login-boss').style.display='block';setTimeout(function(){document.getElementById('boss-password').focus()},100)}
        function backToSelect(){document.getElementById('login-boss').style.display='none';document.getElementById('login-select').style.display='block';document.getElementById('boss-password').value=''}
        function enterBoss(){
            // éªŒè¯æ–°å¯†ç  boss6666
            if(document.getElementById('boss-password').value===CONFIG.bossPassword){
                currentRole='boss';
                showApp()
            } else{
                // æç¤ºæ–‡å­—åŒæ­¥æ›´æ–°
                alert('å¯†ç é”™è¯¯ï¼é»˜è®¤å¯†ç ï¼šboss6666');
                document.getElementById('boss-password').value='';
                document.getElementById('boss-password').focus()
            }
        }
        function showApp(){document.getElementById('login-select').style.display='none';document.getElementById('login-boss').style.display='none';document.getElementById('app-page').style.display='block';initApp()}
        function logout(){if(confirm('ç¡®å®šè¦é€€å‡ºå—ï¼Ÿ'))window.location.href=window.location.pathname}

        function initApp(){
            var badge=document.getElementById('mode-badge'),banner=document.getElementById('info-banner'),costHint=document.getElementById('cost-hint'),costInput=document.getElementById('cost-price'),clearBtn=document.getElementById('clear-btn');
            if(currentRole==='staff'){
                badge.className='mode-badge staff';badge.innerHTML='ğŸ‘¤ åº—å‘˜å½•å…¥';
                banner.innerHTML='ğŸ’¡ åº—å‘˜æ¨¡å¼ï¼šè¯·å½•å…¥å•†å“ä¿¡æ¯å’Œå”®ä»·ï¼Œæˆæœ¬å¯ç•™ç©ºï¼ˆé»˜è®¤0ï¼‰ï¼Œè€æ¿åç»­å¯ä¿®æ”¹';
                costHint.textContent='ï¼ˆé€‰å¡«ï¼‰';costInput.placeholder='ç•™ç©ºåˆ™é»˜è®¤0';costInput.removeAttribute('required');clearBtn.style.display='none';
            }else{
                badge.className='mode-badge boss';badge.innerHTML='ğŸ‘‘ è€æ¿ç®¡ç†';
                banner.innerHTML='ğŸ‘‘ è€æ¿æ¨¡å¼ï¼šæŸ¥çœ‹å®Œæ•´æ•°æ®ï¼Œç‚¹å‡»"ä¿®æ”¹"å¯è°ƒæ•´æˆæœ¬ï¼ŒæŸ¥çœ‹çœŸå®åˆ©æ¶¦';
                costHint.textContent='';costInput.placeholder='80';costInput.setAttribute('required','required');clearBtn.style.display='block';
            }
            document.getElementById('sale-date').valueAsDate=new Date();
            loadData(); // ä»äº‘ç«¯åŠ è½½æ•°æ®
            document.getElementById('sale-form').addEventListener('submit',handleSubmit);
        }

        async function handleSubmit(e){
            e.preventDefault();
            var name=document.getElementById('product-name').value,category=document.getElementById('category').value,saleprice=parseFloat(document.getElementById('sale-price').value),costprice=parseFloat(document.getElementById('cost-price').value)||CONFIG.defaultCost,quantity=parseInt(document.getElementById('quantity').value),date=document.getElementById('sale-date').value;
            if(currentRole==='staff'&&!document.getElementById('cost-price').value&&!confirm('æ‚¨æ²¡æœ‰è¾“å…¥æˆæœ¬ï¼Œç³»ç»Ÿå°†è®°å½•æˆæœ¬ä¸º0ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ\nï¼ˆæç¤ºï¼šè€æ¿åç»­å¯åœ¨æ•°æ®ä¸­è¡¥å……æˆæœ¬ï¼‰'))return;
            
            const { data, error } = await supabaseClient
                .from('sales')
                .insert([{
                    name: name,
                    category: category,
                    saleprice: saleprice,
                    costprice: costprice,
                    quantity: quantity,
                    date: date,
                    timestamp: new Date().getTime(),
                    createdby: currentRole,
                    modifiedby: null,
                    modifiedat: null
                }])
                .select()
            
            if (error) {
                alert('ä¿å­˜å¤±è´¥: ' + error.message)
                return
            }
            
            records.unshift(data[0]);
            updateStats();updateTable();
            document.getElementById('product-name').value='';document.getElementById('sale-price').value='';document.getElementById('cost-price').value='';document.getElementById('quantity').value='1';document.getElementById('product-name').focus();
            showToast('âœ… è®°å½•æ·»åŠ æˆåŠŸï¼');
        }

        function saveData(){
            // äº‘ç«¯ç‰ˆæœ¬ä¸éœ€è¦è¿™ä¸ªå‡½æ•°ï¼Œä¿ç•™ç©ºå‡½æ•°å…¼å®¹æ—§ä»£ç 
        }

        function updateStats(){
            var filtered=getFilteredRecords(),revenue=0,cost=0;
            filtered.forEach(function(r){revenue+=r.saleprice*r.quantity;cost+=r.costprice*r.quantity});
            var profit=revenue-cost,rate=revenue>0?((profit/revenue)*100).toFixed(1):0;
            var grid=document.getElementById('stats-grid');
            if(currentRole==='staff'){
                grid.innerHTML='<div class="stat-box"><div class="stat-label">ä»Šæ—¥è¥æ”¶</div><div class="stat-value">Â¥'+revenue.toFixed(2)+'</div></div><div class="stat-box"><div class="stat-label">é”€å”®ä»¶æ•°</div><div class="stat-value">'+filtered.reduce(function(sum,r){return sum+r.quantity},0)+'ä»¶</div></div><div class="stat-box hidden"><div class="stat-label">æˆæœ¬</div><div class="stat-value">****</div></div><div class="stat-box hidden"><div class="stat-label">åˆ©æ¶¦</div><div class="stat-value">ğŸ”’</div></div>';
            }else{
                grid.innerHTML='<div class="stat-box"><div class="stat-label">è¥ä¸šæ”¶å…¥</div><div class="stat-value">Â¥'+revenue.toFixed(2)+'</div></div><div class="stat-box"><div class="stat-label">æ€»æˆæœ¬</div><div class="stat-value">Â¥'+cost.toFixed(2)+'</div></div><div class="stat-box"><div class="stat-label">å‡€åˆ©æ¶¦</div><div class="stat-value" style="color:'+(profit>=0?'#fff':'#ffebee')+'">Â¥'+profit.toFixed(2)+'</div></div><div class="stat-box"><div class="stat-label">åˆ©æ¶¦ç‡</div><div class="stat-value">'+rate+'%</div></div>';
            }
        }

        function updateTable(){
            var filtered=getFilteredRecords(),header=document.getElementById('records-header'),list=document.getElementById('records-list');
            if(currentRole==='staff'){header.className='records-header staff-view';header.innerHTML='<span>å•†å“ä¿¡æ¯</span><span>å”®ä»·</span><span>æ•°é‡</span><span>è¥æ”¶</span><span>æ“ä½œ</span>';}
            else{header.className='records-header';header.innerHTML='<span>å•†å“ä¿¡æ¯</span><span>å”®ä»·</span><span>æˆæœ¬</span><span>æ•°é‡</span><span>è¥æ”¶</span><span>åˆ©æ¶¦</span><span>æ“ä½œ</span>';}
            if(filtered.length===0){list.innerHTML='<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><div>è¯¥æ—¶é—´æ®µæš‚æ— è®°å½•</div></div>';return;}
            var html='';
            filtered.forEach(function(r){
                var itemRevenue=r.saleprice*r.quantity,itemCost=r.costprice*r.quantity,itemProfit=itemRevenue-itemCost,isProfit=itemProfit>=0;
                if(currentRole==='staff'){
                    html+='<div class="record-row staff-view"><div class="record-product" data-label="å•†å“"><div><div class="record-name">'+r.name+'</div><span class="record-category">'+r.category+'</span></div><div class="record-date">'+r.date+'</div></div><div class="record-cell record-price" data-label="å”®ä»·">Â¥'+r.saleprice.toFixed(2)+'</div><div class="record-cell" data-label="æ•°é‡">'+r.quantity+'</div><div class="record-cell record-price" data-label="è¥æ”¶">Â¥'+itemRevenue.toFixed(2)+'</div><div class="record-actions" data-label="æ“ä½œ"><button class="delete-btn action-btn" onclick="deleteRecord('+r.id+')">åˆ é™¤</button></div></div>';
                }else{
                    html+='<div class="record-row"><div class="record-product" data-label="å•†å“"><div><div class="record-name">'+r.name+'</div><span class="record-category">'+r.category+'</span>'+(r.modifiedby?'<span style="color:#ff9800;font-size:11px;">(å·²ä¿®æ”¹)</span>':'')+'</div><div class="record-date">'+r.date+'</div></div><div class="record-cell record-price" data-label="å”®ä»·">Â¥'+r.saleprice.toFixed(2)+'</div><div class="record-cell" data-label="æˆæœ¬" style="color:'+(r.costprice===0?'#999':'#333')+'">Â¥'+r.costprice.toFixed(2)+(r.costprice===0?'<span style="font-size:10px;color:#999;">(å¾…è¡¥)</span>':'')+'</div><div class="record-cell" data-label="æ•°é‡">'+r.quantity+'</div><div class="record-cell record-price" data-label="è¥æ”¶">Â¥'+itemRevenue.toFixed(2)+'</div><div class="record-cell record-profit '+(isProfit?'profit-positive':'profit-negative')+'" data-label="åˆ©æ¶¦">'+(isProfit?'+':'')+'Â¥'+itemProfit.toFixed(2)+'</div><div class="record-actions" data-label="æ“ä½œ"><button class="edit-btn action-btn" onclick="openEdit('+r.id+')">ä¿®æ”¹</button><button class="delete-btn action-btn" onclick="deleteRecord('+r.id+')">åˆ é™¤</button></div></div>';
                }
            });
            var totalRevenue=0,totalCost=0;
            filtered.forEach(function(r){totalRevenue+=r.saleprice*r.quantity;totalCost+=r.costprice*r.quantity});
            var totalProfit=totalRevenue-totalCost;
            if(currentRole==='staff'){html+='<div class="summary-row staff-view"><div class="summary-label">åˆè®¡ ('+filtered.length+'ç¬”)</div><div>-</div><div>-</div><div class="record-price">Â¥'+totalRevenue.toFixed(2)+'</div><div>-</div></div>';}
            else{html+='<div class="summary-row"><div class="summary-label">åˆè®¡ ('+filtered.length+'ç¬”)</div><div>-</div><div class="record-price">Â¥'+totalCost.toFixed(2)+'</div><div>-</div><div class="record-price">Â¥'+totalRevenue.toFixed(2)+'</div><div class="record-profit '+(totalProfit>=0?'profit-positive':'profit-negative')+'">'+(totalProfit>=0?'+':'')+'Â¥'+totalProfit.toFixed(2)+'</div><div>-</div></div>';}
            list.innerHTML=html;
        }

        function openEdit(id){
            if(currentRole!=='boss'){alert('åªæœ‰è€æ¿æ‰èƒ½ä¿®æ”¹æˆæœ¬');return}
            var record=records.find(function(r){return r.id===id});
            if(!record)return;
            editingId=id;
            document.getElementById('current-info').innerHTML='<strong>'+record.name+'</strong><br>å½“å‰æˆæœ¬ï¼šÂ¥'+record.costprice.toFixed(2)+' | å”®ä»·ï¼šÂ¥'+record.saleprice.toFixed(2)+' | æ•°é‡ï¼š'+record.quantity;
            document.getElementById('edit-cost').value=record.costprice;
            document.getElementById('edit-modal').classList.add('active');
            document.getElementById('edit-cost').focus();
        }

        async function saveEdit(){
            var newCost=parseFloat(document.getElementById('edit-cost').value);
            if(isNaN(newCost)||newCost<0){alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æˆæœ¬é‡‘é¢');return}
            
            const { error } = await supabaseClient
                .from('sales')
                .update({
                    costprice: newCost,
                    modifiedby: 'boss',
                    modifiedat: new Date().toISOString()
                })
                .eq('id', editingId)
            
            if (error) {
                alert('ä¿®æ”¹å¤±è´¥: ' + error.message)
                return
            }
            
            var record=records.find(function(r){return r.id===editingId});
            if(record){
                record.costprice=newCost;
                record.modifiedby='boss';
                record.modifiedat=new Date().toISOString();
                updateStats();
                updateTable();
                showToast('âœ… æˆæœ¬ä¿®æ”¹æˆåŠŸï¼')
            }
            closeModal();
        }

        function closeModal(){document.getElementById('edit-modal').classList.remove('active');editingId=null}
        document.getElementById('edit-modal').addEventListener('click',function(e){if(e.target===this)closeModal()});

        function getFilteredRecords(){
            var now=new Date(),today=new Date(now.getFullYear(),now.getMonth(),now.getDate());
            return records.filter(function(r){
                var rDate=new Date(r.date);
                if(currentFilter==='today')return rDate>=today;
                else if(currentFilter==='week'){var weekAgo=new Date(today.getTime()-7*24*60*60*1000);return rDate>=weekAgo}
                else if(currentFilter==='month')return rDate.getMonth()===now.getMonth()&&rDate.getFullYear()===now.getFullYear();
                return true;
            });
        }

        function filterDate(type){
            currentFilter=type;
            document.querySelectorAll('.date-filter button').forEach(function(btn){btn.classList.remove('active')});
            document.getElementById('btn-'+type).classList.add('active');
            updateStats();updateTable();
        }

        async function deleteRecord(id){
            if(!confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) return
            
            const { error } = await supabaseClient
                .from('sales')
                .delete()
                .eq('id', id)
            
            if (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message)
                return
            }
            
            records=records.filter(function(r){return r.id!==id});
            updateStats();updateTable();
            showToast('ğŸ—‘ï¸ å·²åˆ é™¤')
        }

        function exportData(){
            var filtered=getFilteredRecords();
            if(filtered.length===0){alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');return}
            var csv='\uFEFFå•†å“åç§°,åˆ†ç±»,å”®ä»·,æˆæœ¬,æ•°é‡,æ—¥æœŸ,è¥ä¸šæ”¶å…¥,æˆæœ¬åˆè®¡,åˆ©æ¶¦,å½•å…¥è€…,ä¿®æ”¹è€…\n';
            filtered.forEach(function(r){var revenue=r.saleprice*r.quantity,cost=r.costprice*r.quantity,profit=revenue-cost;csv+=r.name+','+r.category+','+r.saleprice+','+r.costprice+','+r.quantity+','+r.date+','+revenue+','+cost+','+profit+','+(r.createdby==='staff'?'åº—å‘˜':'è€æ¿')+','+(r.modifiedby?'è€æ¿':'')+'\n'});
            var totalRevenue=0,totalCost=0;
            filtered.forEach(function(r){totalRevenue+=r.saleprice*r.quantity;totalCost+=r.costprice*r.quantity});
            csv+='åˆè®¡,,,,,,'+totalRevenue+','+totalCost+','+(totalRevenue-totalCost)+',,\n';
            var blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}),link=document.createElement('a');
            link.href=URL.createObjectURL(blob);
            link.download='é”€å”®è®°å½•_'+new Date().toLocaleDateString()+'.csv';
            link.click();
            showToast('ğŸ“¥ å¯¼å‡ºæˆåŠŸï¼');
        }

        function clearAll(){
            if(currentRole!=='boss'){alert('åªæœ‰è€æ¿æ‰èƒ½æ¸…ç©ºæ•°æ®');return}
            if(confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')){
                // äº‘ç«¯ç‰ˆæœ¬æš‚æ—¶ä¸æ”¯æŒæ‰¹é‡åˆ é™¤ï¼Œéœ€è¦é€æ¡åˆ é™¤æˆ–æ·»åŠ truncateåŠŸèƒ½
                alert('äº‘ç«¯ç‰ˆæœ¬æš‚ä¸æ”¯æŒä¸€é”®æ¸…ç©ºï¼Œè¯·é€æ¡åˆ é™¤æˆ–ä½¿ç”¨Supabaseåå°æ¸…ç©º')
            }
        }

        function showToast(msg){
            var toast=document.createElement('div');
            toast.style.cssText='position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#333;color:white;padding:12px 24px;border-radius:8px;z-index:1000';
            toast.textContent=msg;
            document.body.appendChild(toast);
            setTimeout(function(){toast.remove()},2000);
        }

        document.getElementById('boss-password').addEventListener('keypress',function(e){if(e.key==='Enter')enterBoss()});
    </script>
</body>
</html>
